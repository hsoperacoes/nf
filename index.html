<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Consulta NF-e</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/dynamsoft-javascript-barcode@9.6.21/dist/dbr.js"></script>
  <style>
    body {
      background: #121212;
      color: #fff;
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
    }

    .logo {
      background: #000;
      text-align: center;
      padding: 10px;
    }

    .logo img {
      width: 130px;
    }

    .box {
      background: #1e1e1e;
      max-width: 800px;
      margin: 0 auto;
      padding: 25px;
      border-radius: 8px;
    }

    h2, h3 {
      text-align: center;
    }

    label {
      margin-top: 10px;
      display: block;
    }

    input, button {
      width: 100%;
      padding: 10px;
      margin-top: 8px;
      border: none;
      border-radius: 5px;
      font-size: 16px;
    }

    input {
      background: #2c2c2c;
      color: white;
    }

    button {
      background: #673ab7;
      color: white;
      cursor: pointer;
    }

    .esconde {
      display: none !important;
    }

    .result-box {
      background: #2d2d2d;
      padding: 10px;
      margin-top: 20px;
      border-radius: 5px;
    }

    .erro {
      color: red;
      margin-top: 15px;
    }

    .sair-btn {
      text-align: right;
      margin-bottom: 10px;
    }

    .sair-btn button {
      font-size: 14px;
      padding: 5px 8px;
      background: #444;
    }

    #scanner {
      position: fixed;
      top: 0;
      left: 0;
      z-index: 999;
      width: 100%;
      height: 100vh;
      background: rgba(0,0,0,0.8);
    }
  </style>
</head>
<body>

  <div class="logo">
    <img src="logo.png" alt="Logo">
  </div>

  <!-- LOGIN -->
  <div id="telaLogin" class="box">
    <h2>Login</h2>
    <label>C√≥digo da Filial</label>
    <input type="text" id="codFilial" placeholder="Ex: 293">
    <button onclick="fazerLogin()">Entrar</button>
  </div>

  <!-- PRINCIPAL -->
  <div id="telaPrincipal" class="box esconde">
    <div class="sair-btn">
      <button onclick="logout()">Sair</button>
    </div>
    <h2>Consultar Nota Fiscal</h2>
    <label>Chave de Acesso (44 d√≠gitos)</label>
    <input type="text" id="campoChave" maxlength="44" placeholder="Digite a chave aqui">
    <button onclick="ligarLeitor()">üì∑ Ler C√≥digo de Barras</button>
    <div id="scanner" style="display: none;"></div>
    <button onclick="consultar()">Consultar</button>

    <div id="carregando" class="esconde">‚è≥ Consultando...</div>
    <div id="resposta" class="result-box esconde"></div>
    <div id="msgErro" class="erro"></div>

    <div class="result-box">
      <h3>Hist√≥rico</h3>
      <ul id="listaHistorico"></ul>
      <button onclick="limpar()">üóë Limpar Hist√≥rico</button>
    </div>
  </div>

  <script>
    const URL = "https://script.google.com/macros/s/AKfycbwfoYOgleHUcmbr_1B8tV_NG6cEZxcHm5zBSrJ0ItgRV_Cp7tumh3GjBzsvzTSNJ5sbmA/exec";
    const codigos = ["293", "488", "287", "288", "999"];
    let leitor = null;

    function fazerLogin() {
      let cod = document.getElementById("codFilial").value.trim();
      if (!codigos.includes(cod)) {
        alert("Filial inv√°lida.");
        return;
      }
      localStorage.setItem("filial", cod);
      document.getElementById("telaLogin").classList.add("esconde");
      document.getElementById("telaPrincipal").classList.remove("esconde");
      carregarHistorico();
    }

    function logout() {
      localStorage.removeItem("filial");
      location.reload();
    }

    function limpar() {
      let senha = prompt("Senha para limpar?");
      if (senha !== "hs") {
        alert("Senha errada.");
        return;
      }
      localStorage.removeItem("historico_" + localStorage.getItem("filial"));
      document.getElementById("listaHistorico").innerHTML = "";
    }

    function consultar() {
      let filial = localStorage.getItem("filial");
      let chave = document.getElementById("campoChave").value.trim();
      let resposta = document.getElementById("resposta");
      let erro = document.getElementById("msgErro");
      let loading = document.getElementById("carregando");

      resposta.classList.add("esconde");
      erro.innerText = "";

      if (!chave || chave.length !== 44) {
        erro.innerText = "Chave inv√°lida.";
        return;
      }

      let historico = JSON.parse(localStorage.getItem("historico_" + filial)) || [];
      if (historico.find(i => i.chave === chave)) {
        erro.innerText = "Essa chave j√° foi consultada.";
        return;
      }

      loading.classList.remove("esconde");

      fetch(`${URL}?chave=${chave}&filial=${filial}`)
        .then(r => r.json())
        .then(d => {
          if (d.success) {
            resposta.classList.remove("esconde");
            resposta.innerHTML = `
              <p><b>NF:</b> ${d.data.numeroNF}</p>
              <p><b>Valor:</b> ${d.data.valorTotal}</p>
              <p><b>Qtde:</b> ${d.data.quantidadeTotal}</p>
              <p><b>Status:</b> ‚úÖ ${d.data.status}</p>
            `;
            historico.push({ chave, ...d.data, dataHora: new Date().toISOString() });
            localStorage.setItem("historico_" + filial, JSON.stringify(historico));
            carregarHistorico();
          } else {
            erro.innerText = d.message || "Erro ao consultar.";
          }
        })
        .catch(() => erro.innerText = "Erro de conex√£o.")
        .finally(() => loading.classList.add("esconde"));
    }

    function carregarHistorico() {
      let filial = localStorage.getItem("filial");
      let lista = document.getElementById("listaHistorico");
      let historico = JSON.parse(localStorage.getItem("historico_" + filial)) || [];
      lista.innerHTML = "";

      if (historico.length === 0) {
        lista.innerHTML = "<li>Nenhum registro.</li>";
        return;
      }

      historico.reverse().forEach(item => {
        let data = new Date(item.dataHora).toLocaleDateString("pt-BR");
        lista.innerHTML += `<li>${data} - NF ${item.numeroNF} - ${item.valorTotal} - ${item.quantidadeTotal} itens</li>`;
      });
    }

    async function ligarLeitor() {
      let tela = document.getElementById("scanner");
      tela.style.display = "flex";

      Dynamsoft.DBR.BarcodeScanner.license = "DLS2eyJoYW5kc2hha2VDb2RlIjoiMTA0MDgyMzg1LVRYbFhaV0pRY205cSIsIm1haW5TZXJ2ZXJVUkwiOiJodHRwczovL21kbHMuZHluYW1zb2Z0b25saW5lLmNvbSIsIm9yZ2FuaXphdGlvbklEIjoiMTA0MDgyMzg1Iiwic3RhbmRieVNlcnZlclVSTCI6Imh0dHBzOi8vc2Rscy5keW5hbXNvZnRvbmxpbmUuY29tIiwiY2hlY2tDb2RlIjoxNzI0OTg5ODA0fQ==";

      try {
        leitor = await Dynamsoft.DBR.BarcodeScanner.createInstance();
        await leitor.updateRuntimeSettings("speed");

        leitor.onFrameRead = resultados => {
          for (let r of resultados) {
            if (r.barcodeText.length >= 44) {
              document.getElementById("campoChave").value = r.barcodeText.slice(0, 44);
              if (leitor) {
                leitor.hide();
                leitor.stop();
                leitor = null;
              }
              tela.style.display = "none";
              break;
            }
          }
        };

        await leitor.show(tela);
      } catch (erro) {
        alert("Erro no leitor: " + erro.message);
        tela.style.display = "none";
      }
    }

    // Auto-login se tiver salvo
    window.onload = () => {
      let filial = localStorage.getItem("filial");
      if (filial) {
        document.getElementById("telaLogin").classList.add("esconde");
        document.getElementById("telaPrincipal").classList.remove("esconde");
        carregarHistorico();
      }
    }
  </script>
</body>
</html>
