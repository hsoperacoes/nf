<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NF-e - Consulta Simples</title>
  <style>
    body {
      background: #111;
      color: #eee;
      font-family: sans-serif;
      padding: 20px;
    }
    .box {
      background: #1c1c1c;
      max-width: 700px;
      margin: 30px auto;
      padding: 25px;
      border-radius: 8px;
      box-shadow: 0 0 8px #000;
    }
    h1 {
      text-align: center;
      color: #bbb;
    }
    label {
      display: block;
      margin-top: 15px;
      margin-bottom: 5px;
      font-weight: bold;
    }
    input {
      width: 100%;
      padding: 8px;
      border: none;
      border-radius: 4px;
      background: #333;
      color: #fff;
    }
    button {
      margin-top: 20px;
      width: 100%;
      padding: 12px;
      background: #4a2caf;
      color: #fff;
      border: none;
      border-radius: 4px;
      font-size: 16px;
      cursor: pointer;
    }
    .res, .erro, .loading {
      margin-top: 20px;
      padding: 15px;
      background: #2a2a2a;
      border-radius: 5px;
    }
    .erro { color: #ff6b6b; }
    .res p { margin: 8px 0; }
    .hist ul { padding-left: 20px; }
  </style>
</head>
<body>
  <div class="box" id="telaLogin">
    <h1>Entrar</h1>
    <label>CÃ³digo da Filial:</label>
    <input type="text" id="filial" placeholder="Ex: 293">
    <button onclick="entrar()">Confirmar</button>
  </div>

  <div class="box hidden" id="telaConsulta">
    <button style="float:right;font-size:13px;padding:4px 10px" onclick="sair()">Sair</button>
    <h1>Consulta NF-e</h1>

    <label>Chave da NF (44 dÃ­gitos):</label>
    <input type="text" id="chave" maxlength="44" placeholder="Digite a chave">
    <button onclick="consultarNota()">Consultar Nota</button>

    <div id="carregando" class="loading hidden">Consultando... aguarde...</div>
    <div id="resultado" class="res hidden"></div>
    <div id="erro" class="erro"></div>

    <div class="hist">
      <h3>HistÃ³rico</h3>
      <ul id="listaHistorico"></ul>
      <button onclick="limparHist()">ðŸ—‘ Limpar</button>
    </div>
  </div>

  <script>
    const URL = "https://script.google.com/macros/s/AKfycbwUa5DLhtKpa2kUAMxicHQsPlIG3gsLW-D3Scq6WUjAw42JIcUerAgy4f1H3TxsJLTB/exec";

    function entrar() {
      const cod = document.getElementById('filial').value.trim();
      if (!cod) return alert("Digite o cÃ³digo da filial!");
      localStorage.setItem("filial", cod);
      document.getElementById('telaLogin').classList.add('hidden');
      document.getElementById('telaConsulta').classList.remove('hidden');
      carregarHist(cod);
    }

    function sair() {
      localStorage.removeItem("filial");
      location.reload();
    }

    function consultarNota() {
      const filial = localStorage.getItem("filial");
      const chave = document.getElementById('chave').value.trim();
      const res = document.getElementById('resultado');
      const erro = document.getElementById('erro');
      const loading = document.getElementById('carregando');
      
      res.classList.add('hidden');
      erro.innerText = "";
      if (!filial || chave.length !== 44) {
        erro.innerText = "CÃ³digo da filial ou chave invÃ¡lida.";
        return;
      }

      const historico = JSON.parse(localStorage.getItem("hist_" + filial)) || [];
      if (historico.find(n => n.chave === chave)) {
        erro.innerText = "Essa nota jÃ¡ foi consultada.";
        return;
      }

      loading.classList.remove('hidden');
      fetch(`${URL}?chave=${chave}&filial=${filial}`)
        .then(r => r.json())
        .then(data => {
          if (data.success) {
            res.innerHTML = `
              <p><b>NÃºmero:</b> ${data.data.numeroNF}</p>
              <p><b>Valor:</b> ${data.data.valorTotal}</p>
              <p><b>Qtd Itens:</b> ${data.data.quantidadeTotal}</p>
              <p><b>Status:</b> âœ… ${data.data.status}</p>
            `;
            res.classList.remove('hidden');
            historico.push({ chave, numero: data.data.numeroNF });
            localStorage.setItem("hist_" + filial, JSON.stringify(historico));
            carregarHist(filial);
          } else {
            erro.innerText = data.message || 'Erro ao consultar nota';
          }
        })
        .catch(() => erro.innerText = "Erro de conexÃ£o")
        .finally(() => loading.classList.add('hidden'));
    }

    function carregarHist(filial) {
      const lista = document.getElementById('listaHistorico');
      const hist = JSON.parse(localStorage.getItem("hist_" + filial)) || [];
      lista.innerHTML = hist.length === 0 ? "<li>Nenhum registro</li>" : "";
      hist.slice().reverse().forEach(n => {
        lista.innerHTML += `<li>NF ${n.numero}</li>`;
      });
    }

    function limparHist() {
      if (prompt("Senha para limpar histÃ³rico?") !== "hs") return alert("Negado!");
      const filial = localStorage.getItem("filial");
      localStorage.removeItem("hist_" + filial);
      carregarHist(filial);
    }

    window.onload = () => {
      const filial = localStorage.getItem("filial");
      if (filial) {
        document.getElementById('telaLogin').classList.add('hidden');
        document.getElementById('telaConsulta').classList.remove('hidden');
        carregarHist(filial);
      }
    };
  </script>
</body>
</html>
